syntax = "proto3";
package protocol;
option go_package = "./protocol";

enum MessageType {
  PRODUCE = 0;        
  DATA = 1;           
  CONSUME = 2;        
  RESULT = 3;         
  REPLICATE = 4;     
  HEARTBEAT = 5;    
  JOIN = 6;          
  JOIN_RESPONSE = 7;  
  ELECTION = 8;      
  NACK = 9;           
}

enum NodeType {
  LEADER = 0;
  BROKER = 1;
  PRODUCER = 2;
  CONSUMER = 3;
}

message MessageHeader {
  MessageType type = 1;
  int64 timestamp = 2;
  string sender_id = 3;
  int64 sequence_num = 4;
  NodeType sender_type = 5;
}

// TCP unicast from Producer to Leader
message ProduceMessage {
  MessageHeader header = 1;
  string topic = 2;
  string producer_address = 3;
}

// UDP unicast from Producer to Broker
message DataMessage {
  MessageHeader header = 1;
  string topic = 2;
  bytes data = 3;
}

// TCP unicast from Consumer to Leader
message ConsumeMessage {
  MessageHeader header = 1;
  string topic = 2;
  string consumer_address = 3;
}

// TCP unicast from Broker to Consumer
message ResultMessage {
  MessageHeader header = 1;
  string topic = 2;
  bytes data = 3;
  int64 offset = 4;
}

// TCP unicast for Leader to Producer/Consumer
// TCP unicast for Broker to Leader
// UDP multicast for Leader to Brokers
message HeartbeatMessage {
  MessageHeader header = 1;
}

// UDP broadcast from new node to discover cluster
message JoinMessage {
  MessageHeader header = 1;
  string address = 2;
}

// UDP unicast from Leader to new node
message JoinResponseMessage {
  MessageHeader header = 1;
  bool success = 2;
  string leader_address = 3;
  string multicast_group = 4;
  repeated string broker_addresses = 5;
}

// TCP unicast from Broker to next Broker in logical ring
message ElectionMessage {
  MessageHeader header = 1;
  string candidate_id = 2;
  int64 election_id = 3;
  enum Phase {
    ANNOUNCE = 0;
    VICTORY = 1;
  }
  Phase phase = 4;
}

// UDP multicast from Leader to Brokers, FIFO ordering
message ReplicateMessage {
  MessageHeader header = 1;
  bytes state_snapshot = 2;
  string update_type = 3;
}

// TCP unicast from Broker to specific sender
// UDP multicast from Broker to all (if sender unknown)
message NackMessage {
  MessageHeader header = 1;
  string target_sender_id = 2;
  int64 from_seq = 3;
  int64 to_seq = 4;
}
